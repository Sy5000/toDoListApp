<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ToDoApp</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <header class="flex">
      <h3>welcome back, repo</h3>
      <blockquote contenteditable="true">...</blockquote>
    </header>

    <main>
      <section style="display: block">
        <h3>inputs</h3>
        <input type="text" id="newUserTask" placeholder="add a new task" />
        <!-- <label for="cat-select"></label> -->
        <select name="categories" id="categories-select">
          <!-- <option value="">- please select a category -</option>
          <option value="misc">Default</option>
          <option value="personal">Personal</option>
          <option value="work">Work</option> -->
        </select>
        <input type="submit" id="submitTask" />
        <br />
        <br />
        <input type="text" id="newUserCat" placeholder="create a category" />
        <input type="submit" id="submitCategory" />
      </section>

      <section>
        <h3>filters</h3>

        <div class="flex">
          <div>
            <button type="button" id="filters-remove">n/a</button>
          </div>
          <div id="filters-select"></div>
        </div>
      </section>

      <section>
        <h3>list</h3>
        <ul id="masterList">
          <!-- <li>do a list</li> -->
          <!-- <li data-cat="misc">
            <span class="listItem checked">style test 001</span>
            <span class="close"></span>
          </li>
          <li class="" data-cat="misc">
            <span class="listItem">style test 0000002</span>
            <span class="close"></span>
          </li>
          <li class="" data-cat="personal">
            style test #3<span class="close"></span>
          </li> -->
        </ul>
      </section>

      <section>
        <h4>analytics</h4>
        <hr />
      </section>
    </main>
  </body>
</html>

<script>
  "use strict";
  // pointers
  const masterList = document.querySelector("#masterList");
  const categoriesSelect = document.querySelector("#categories-select");
  const filtersSelect = document.querySelector("#filters-select");
  const filtersRemove = document.querySelector("#filters-remove");
  const createTask = document.querySelector("#submitTask");
  const createCategory = document.querySelector("#submitCategory");

  // MODEL
  // globals
  const categories = ["misc", "personal", "work"];
  let list = [
    {
      task: "create a list",
      category: "misc",
      complete: true,
    },
    {
      task: "display the list",
      category: "misc",
      complete: false,
    },
    {
      task: "buy apples",
      category: "misc",
      complete: true,
    },
    {
      task: "buy soup",
      category: "personal",
      complete: true,
    },
  ];
  let curState = false;

  ////////////////////
  ////////////////////
  // init app
  renderCategorySelect(categories);
  renderfilterBy(categories);
  renderList(list);
  ////////////////////
  ////////////////////

  ////////////////////
  // VIEWs
  //  to-do-list

  //  categories-select-list
  function renderCategorySelect(categories) {
    categoriesSelect.innerHTML =
      "<option value=''>- please select a category -</option>";
    categories.forEach((el) => {
      categoriesSelect.insertAdjacentHTML(
        "beforeend",
        `<option value="${el}">${el}</option>`
      );
    });
  }
  //  filters-list
  function renderfilterBy(categories) {
    // existing html
    filtersSelect.innerHTML = "";
    categories.forEach((el) => {
      filtersSelect.insertAdjacentHTML(
        "beforeend",
        `<button type='button' class='filter__button' data-cat='${el}'>
                    ${el}
                  </button>`
      );
    });
  }

  function renderList(list) {
    // existing html
    masterList.innerHTML = "";
    // model obj
    list.forEach((el) => {
      // check task status
      let style = el.complete === true ? "checked" : "";
      // new html
      masterList.insertAdjacentHTML(
        "beforeend",
        `<li class='${style}' data-cat='${el.category}'>${el.task}<span class='close'></span></li>`
      );
    });
  }

  // function renderListWithState(list, curState) {
  //   let aFilteredList = list.filter((el) => el.category === curState);
  //   // console.log(aFilteredList);
  //   renderList(aFilteredList);
  // }

  // THIS IS NOT QUITE MODEL VIEW :(
  // function renderListWithState(list, curState) {
  //   let aFilteredList = list.filter((el) => el.category === curState);
  //   // console.log(aFilteredList);
  //   renderList(aFilteredList);
  // }

  ////////////////////
  // CONTROLLERs
  //  add task to list, update VIEWs
  createTask.addEventListener("click", () => {
    const task = document.querySelector("#newUserTask");
    const categorySelect = document.querySelector("#categories-select");
    // MODEL
    const newTask = {
      task: task.value,
      category: categorySelect.value,
      complete: false,
    };
    list.unshift(newTask);
    // VIEW
    renderList(list);
    // clear inputs
    task.value = categorySelect.value = "";
  });

  //  add a custom cat, update VIEWs
  createCategory.addEventListener("click", () => {
    const category = document.querySelector("#newUserCat");
    const newCategory = category.value;

    if (newCategory === "") {
      alert("please enter a valid value!");
    }
    if (newCategory !== "") {
      // MODEL
      categories.push(newCategory);
      // VIEW
      category.value = "";
      renderCategorySelect(categories);
      renderfilterBy(categories);
      console.log(categories);
    }
  });

  // filterBy list, update VIEWs
  filtersSelect.addEventListener("click", function (e) {
    let target = e.target.closest(".filter__button");
    // guard
    if (!target) {
      return;
    }
    let chosenFilter = target.dataset.cat;
    // GLOBAL state
    curState = chosenFilter;

    // MODEL
    let filteredList = list.filter(
      (filterBy) => filterBy.category === chosenFilter
    );
    // renderListWithState(list, curState);

    // VIEW
    renderList(filteredList);
  });

  // remove filters, update VIEWs
  filtersRemove.addEventListener("click", function (e) {
    // MODEL
    curState = false;
    // VIEW
    renderList(list);
  });

  // toggle task status, remove tasks, spdate VIEWs
  masterList.addEventListener("click", function (e) {
    let target = e.target;
    let string = target.textContent;
    // when close/child is clicked
    let li = target.closest("li");

    // target list
    if (target.tagName === "LI") {
      // VIEW
      target.classList.toggle("checked");
      // MODEL
      list.forEach((el) => {
        if (el.task.match(string)) {
          // toggle boolean value
          let curBool = el.complete;
          el.complete = !curBool;
        }
      });
    }
    // target close buttons
    if (target.classList.contains("close")) {
      // MODEL
      list = list.filter((el) => el.task != li.textContent);
      // VIEWs
      if (!curState) {
        renderList(list);
      }
      if (curState) {
        let withFilter = list.filter((el) => el.category === curState);
        renderList(withFilter);
        // renderListWithState(list, curState);
      }
    }
  });

  function calcAnalytics() {}

  function updateDOM() {}

  //
  // REQUIREMENTS
  //
  // ✅ task input
  // ✅ display tasks
  //
  // ✅ custom category input
  // ✅ show custom cat in categories dropdown (hot reload data?)
  // ✅ show custom category as filters
  // ✅ filter list by custom categories (problem event delagation for new buttons)
  //
  // ✅ toggle a task (complete/incomplete)
  // remove a task
  // remove a category (auto or remove button?)
  //
  // persist tasks / custom cats / input data
  // logic to prompt when list is empty
  //
  // task analytics
  // style
  // micro-animations

  // BUGS / extra functionality
  //
  // remove button calls renderList(list)
  // this ignores filters which should maintain state
  //
  // do not allow duplicate list items?
</script>
